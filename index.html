<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Vizi Metronome</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
    margin: 0;
    padding: 0;
    background: #5a3e2b; /* brown */
    color: #fff3e6;
    font-family: Arial, sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }

  .panel {
    background: #6b4a34;
    padding: 20px;
    border-radius: 14px;
    width: 90%;
    max-width: 420px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.45);
    text-align: center;
  }

  h1 {
    margin: 0 0 12px;
    font-size: 1.4rem;
  }

  label {
    display: block;
    text-align: left;
    margin-top: 14px;
    font-size: 0.9rem;
  }

  select, input[type="range"] {
    width: 100%;
    margin-top: 6px;
  }

  .bpm-display {
    margin-top: 6px;
    font-size: 1.1rem;
    text-align: center;
  }

  .beat-circle {
    margin: 18px auto;
    width: 85px;
    height: 85px;
    border-radius: 50%;
    background: #3f2a1f;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.5rem;
    transition: background 0.08s ease, transform 0.08s ease;
  }

  .accent {
    background: #d97706;
    transform: scale(1.12);
  }

  .normal {
    background: #a16207;
    transform: scale(1.05);
  }

  .controls {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-top: 10px;
  }

  button {
    border: none;
    padding: 10px 22px;
    font-size: 0.9rem;
    border-radius: 999px;
    cursor: pointer;
    color: #2e1f15;
    background: #fbbf24;
  }

  button.stop {
    background: #ef4444;
    color: white;
  }

  button:active {
    transform: translateY(1px);
  }

  .small {
    margin-top: 10px;
    font-size: 0.8rem;
    opacity: 0.85;
  }
</style>
</head>

<body>

<div class="panel">
  <h1>Vizi Metronome</h1>

  <label>
    Time Signature
    <select id="timeSig">
      <option value="4">4 / 4 (most songs)</option>
      <option value="3">3 / 4</option>
      <option value="2">2 / 4</option>
      <option value="6">6 / 8</option>
      <option value="5">5 / 4</option>
    </select>
  </label>

  <label>
    Tempo (BPM)
    <input id="bpmSlider" type="range" min="40" max="200" value="80">
    <div class="bpm-display"><span id="bpmValue">80</span> BPM</div>
  </label>

  <div id="beatCircle" class="beat-circle">1</div>

  <div class="controls">
    <button onclick="startMetronome()">Start</button>
    <button class="stop" onclick="stopMetronome()">Stop</button>
  </div>

  <div class="small">
    Tip: Start slow. Lock your strumming to the click.
  </div>
</div>

<script>
  let audioCtx = null;
  let timerId = null;
  let isRunning = false;
  let bpm = 80;
  let beatsPerMeasure = 4;
  let currentBeat = 0;

  const bpmSlider = document.getElementById("bpmSlider");
  const bpmValue  = document.getElementById("bpmValue");
  const timeSig   = document.getElementById("timeSig");
  const beatCircle = document.getElementById("beatCircle");

  bpmSlider.addEventListener("input", () => {
    bpm = parseInt(bpmSlider.value, 10);
    bpmValue.textContent = bpm;
    if (isRunning) restartMetronome();
  });

  timeSig.addEventListener("change", () => {
    beatsPerMeasure = parseInt(timeSig.value, 10);
    currentBeat = 0;
    if (isRunning) restartMetronome();
  });

  function createAudioContext() {
    if (!audioCtx) {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
  }

  function playClick(isAccent) {
    createAudioContext();
    if (!audioCtx) return;

    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    const now = audioCtx.currentTime;

    osc.frequency.value = isAccent ? 1000 : 700;
    gain.gain.setValueAtTime(isAccent ? 0.8 : 0.5, now);
    gain.gain.exponentialRampToValueAtTime(0.001, now + 0.06);

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start(now);
    osc.stop(now + 0.07);
  }

  function updateVisual(isAccent) {
    beatCircle.textContent = currentBeat + 1;
    beatCircle.classList.remove("accent", "normal");
    beatCircle.classList.add(isAccent ? "accent" : "normal");
    setTimeout(() => {
      beatCircle.classList.remove("accent", "normal");
    }, 90);
  }

  function scheduleNextBeat() {
    const intervalMs = 60000 / bpm;
    timerId = setInterval(() => {
      currentBeat = (currentBeat + 1) % beatsPerMeasure;
      const isAccent = (currentBeat === 0);
      playClick(isAccent);
      updateVisual(isAccent);
    }, intervalMs);
  }

  function startMetronome() {
    if (isRunning) return;
    isRunning = true;
    currentBeat = -1;
    scheduleNextBeat();
  }

  function stopMetronome() {
    isRunning = false;

    if (timerId !== null) {
      clearInterval(timerId);
      timerId = null;
    }

    if (audioCtx) {
      audioCtx.close();
      audioCtx = null;
    }

    beatCircle.textContent = "1";
    beatCircle.classList.remove("accent", "normal");
    currentBeat = 0;
  }

  function restartMetronome() {
    stopMetronome();
    startMetronome();
  }

  /* EXPOSE FUNCTIONS FOR MIT APP INVENTOR */
  window.forceStartMetronome = startMetronome;
  window.forceStopMetronome  = stopMetronome;
  window.setBPM = function(val) {
    bpm = parseInt(val, 10);
    bpmSlider.value = bpm;
    bpmValue.textContent = bpm;
    if (isRunning) restartMetronome();
  };
</script>

</body>
</html>
